name: Convert bundletool.jar to Native x64

on:
  workflow_dispatch:

jobs:
  build-native:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up GraalVM (Java 21) with native-image
        uses: graalvm/setup-graalvm@v1
        with:
          distribution: 'graalvm-community'
          version: '23.3.2'
          java-version: '21'
          components: 'native-image'

      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip zip clang build-essential pkg-config zlib1g-dev

      - name: Prepare bundletool JAR
        run: |
          mkdir -p bundletool
          if [ ! -f bundletool/bundletool.jar ]; then echo "bundletool/bundletool.jar missing"; ls -la; exit 1; fi

      - name: Build Native x64 Bundletool
        run: |
          native-image --no-fallback -jar bundletool/bundletool.jar -H:Name=bundletool-native

      - name: Upload Native Binary
        uses: actions/upload-artifact@v4
        with:
          name: bundletool-native-linux-x64
          path: bundletool-native
